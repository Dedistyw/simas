<?php session_start(); require_once __DIR__.'/../config/database.php'; require_once __DIR__.'/../config/helpers.php'; if(!isset($_SESSION['user'])) header('Location: login.php'); $judul=$_POST['judul']??''; $deskripsi=$_POST['deskripsi']??''; $tanggal=$_POST['tanggal']?:date('Y-m-d'); if(!isset($_FILES['foto'])){ header('Location: galeri.php?msg=err'); exit; } if($_FILES['foto']['error']!==UPLOAD_ERR_OK){ header('Location: galeri.php?msg=err_upload'); exit; } $name=time().'_'.preg_replace('/[^a-zA-Z0-9._-]/','_',$_FILES['foto']['name']); $dest_dir=__DIR__.'/../uploads/galeri/'; if(!is_dir($dest_dir)) mkdir($dest_dir,0755,true); $dest=$dest_dir.$name; if(move_uploaded_file($_FILES['foto']['tmp_name'],$dest)){ $fileUrl='/simas/uploads/galeri/'.$name; $stmt=$conn->prepare("INSERT INTO galeri (judul,deskripsi,file,tanggal,uploaded_by) VALUES (?,?,?,?,?)"); $user=$_SESSION['user']; $stmt->bind_param('sssss',$judul,$deskripsi,$fileUrl,$tanggal,$user); $stmt->execute(); catat_log('GALERI','INFO','Upload '.$name,'', $user); header('Location: galeri.php?msg=success'); exit; } else { header('Location: galeri.php?msg=err_upload'); exit; } ?>